version: "3.8"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      cache_from:
        - eros:latest
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: eros
    container_name: eros-app
    ports:
      - "9697:3000"  # Frontend
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - DATABASE_PATH=/data/app.db
      - SCENES_PATH=/app/media/scenes
      - INCOMPLETE_PATH=/app/media/incomplete
      - SESSION_SECRET=${SESSION_SECRET:-change-this-secret}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      # Don't override NEXT_PUBLIC_API_URL - let Dockerfile default (/api) work for browser
      # Browser needs relative URL, not localhost which resolves to user's machine in Docker
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - ./data:/data:rw
      - ${MEDIA_PATH:-./media}:/app/media:rw
    networks:
      - eros-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "Promise.all([fetch('http://localhost:3000'),fetch('http://localhost:3001/health')]).then(()=>process.exit(0)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Istanbul}
      - WEBUI_PORT=8080
      - TORRENTING_PORT=6881
    volumes:
      - ./qbittorrent/appdata:/config
      - ${MEDIA_PATH:-./media}:/app/media
    ports:
      - "8080:8080"
      - "6881:6881"
      - "6881:6881/udp"
    networks:
      - eros-network
    restart: unless-stopped

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Istanbul}
    volumes:
      - ./prowlarr/data:/config
    ports:
      - "9696:9696"
    networks:
      - eros-network
    restart: unless-stopped

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_HTML=${LOG_HTML:-false}
      - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}
      - TZ=${TZ:-Europe/Istanbul}
    ports:
      - "${FLARESOLVERR_PORT:-8191}:8191"
    networks:
      - eros-network
    restart: unless-stopped

networks:
  eros-network:
    driver: bridge

volumes:
  eros-data:
    driver: local
